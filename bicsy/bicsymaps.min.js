(function(){function u(a){a.active>=r||!a.queued.length||(a.active++,a.queued.pop()())}function t(a,b){function h(a){e.active--,++f.attempt<s?e.queued.push(f):b(null),u(e)}function g(){e.active--,u(e)}function f(){var d=new XMLHttpRequest;d.open("GET",a,!0),d.responseType="arraybuffer",d.onreadystatechange=function(){if(d.readyState===4&&d.status===200){var a=document.createElement("canvas");a.height=255,a.width=255;if(d.response===null)return;var e=c(d.response,a).toDataURL(),f=new Image;f.src=e,b(f),g()}},d.onerror=h,d.send(null)}var d=(q.lastIndex=0,q).exec(a)[2]||"",e=p[d]||(p[d]={active:0,queued:[]});f.attempt=0,e.queued.push(f),u(e)}function o(a,b,c,d){var e=m(a,b),f=m(b,c),g=m(c,a);if(e.dy>f.dy){var h=e;e=f,f=h}if(e.dy>g.dy){var h=e;e=g,g=h}if(f.dy>g.dy){var h=f;f=g,g=h}e.dy&&n(g,e,d),f.dy&&n(g,f,d)}function n(a,b,c){var d=Math.floor(b.y0),e=Math.ceil(b.y1);if(a.x0==b.x0&&a.y0==b.y0?a.x0+b.dy/a.dy*a.dx<b.x1:a.x1-b.dy/a.dy*a.dx<b.x0){var f=a;a=b,b=f}var g=a.dx/a.dy,h=b.dx/b.dy,i=a.dx>0,j=b.dx<0;for(var k=d;k<e;k++){var l=Math.ceil(g*Math.max(0,Math.min(a.dy,k+i-a.y0))+a.x0),m=Math.floor(h*Math.max(0,Math.min(b.dy,k+j-b.y0))+b.x0);for(var n=m;n<l;n++)c(n,k)}}function m(a,b){if(a[1]>b[1]){var c=a;a=b,b=c}return{x0:a[0],y0:a[1],x1:b[0],y1:b[1],dx:b[0]-a[0],dy:b[1]-a[1]}}function l(){for(var a=h;i>j&&a;a=a.previous){i--,delete f[a.key];if(a.next)a.next.previous=a.previous;else if(h=a.previous)h.next=null;if(a.previous)a.previous.next=a.next;else if(g=a.next)g.previous=null}}function k(a,b){var c=f[a];if(c){c.previous&&(c.previous.next=c.next,c.next?c.next.previous=c.previous:h=c.previous,c.previous=null,c.next=g,g.previous=c,g=c);return c.callbacks?c.callbacks.push(b):b(c.value)}c=f[a]={key:a,next:g,previous:null,callbacks:[b]},g?g.previous=c:h=c,g=c,i++,l(),t(a,function(a){var b=c.callbacks;delete c.callbacks,c.value=a,b.forEach(function(b){b(a)})})}function e(a,c,d){var e=0,c=c,f=a.getUint32(c,!0),g=a.getUint32(c+4,!0);b(g,d),c+=8,d.beginPath(),d.moveTo(a.getUint8(c,!0),255-a.getUint8(c+1,!0)),c+=2;if(f===2){d.lineTo(a.getUint8(c,!0),255-a.getUint8(c+1,!0)),d.closePath(),d.stroke();return c+2}for(var h=2;h<2*(f-1);h+=2)d.lineTo(a.getUint8(c+h,!0),255-a.getUint8(c+h+1,!0));d.stroke();return c+2*(f-1)}function d(a,b,c){var d=0,b=b,e=a.getUint32(b,!0),f=a.getUint32(b+4,!0);b+=8;if(e===0)return b;c.moveTo(a.getUint8(b,!0),255-a.getUint8(b+1,!0)),c.beginPath();var g=a.getUint8(b,!0),h=255-a.getUint8(b+1,!0);b+=2;if(e===2){c.lineTo(a.getUint8(b,!0),255-a.getUint8(b+1,!0)),c.closePath(),c.stroke();return b+2}for(var i=2;i<2*(e-1);i+=2)c.lineTo(a.getUint8(b+i,!0),255-a.getUint8(b+i+1,!0));c.stroke(),c.fill();return b+2*(e-1)}function c(a,b){var c=a.byteLength,f=0,g=b.getContext("2d"),h,i,j,k,l,m,n,o,p=new DataView(a,0,c);while(f<c)h=p.getUint32(f,!0),i=p.getUint32(f+4,!0),h===2?i>0?f=e(p,f+4,g):f+=12:h===3?f=d(p,f+4,g):(h=0,f+=12);return b}function b(b,c){c.shadowColor="rgba(100,100,100,.7)",c.shadowBlur=2,c.shadowOffsetX=1,c.shadowOffsetY=1,c.strokeStyle=a[b].color,c.lineWidth=a[b].width}bicsymaps={version:"0.0.1"};var a={0:{cls:"residential",color:"rgba(159,159,159,1)",width:.75},1:{cls:"bridleway",color:"rgba(200,45,45,1)",width:2},2:{cls:"construction",color:"rgba(200,45,45,1)",width:2},3:{cls:"crossing",color:"rgba(200,45,45,1)",width:2},4:{cls:"cycleway",color:"rgba(25,150,25,1)",width:1.5},5:{cls:"footway",color:"rgba(20,100,20,1)",width:.5},6:{cls:"footway_unconstructed",color:"rgba(200,45,45,1)",width:2},7:{cls:"living_street",color:"rgba(200,45,45,1)",width:2},8:{cls:"motorway",color:"rgba(200,25,25,1)",width:3},9:{cls:"motorway_link",color:"rgba(200,45,45,1)",width:3},10:{cls:"path",color:"rgba(45,45,200,1)",width:4},11:{cls:"pedestrian",color:"rgba(200,45,45,1)",width:.5},12:{cls:"platform",color:"rgba(200,45,45,1)",width:.2},13:{cls:"primary",color:"rgba(200,45,45,1)",width:6},14:{cls:"primary_link",color:"rgba(200,45,45,1)",width:3},15:{cls:"proposed",color:"rgba(200,45,45,1)",width:2},16:{cls:"raceway",color:"rgba(200,45,45,1)",width:2},17:{cls:"abandoned",color:"rgba(200,45,45,1)",width:2},18:{cls:"road",color:"rgba(200,25,25,1)",width:2},19:{cls:"secondary",color:"rgba(150,150,20,1)",width:4},20:{cls:"secondary_link",color:"rgba(200,45,45,1)",width:2},21:{cls:"service",color:"rgba(200,45,45,1)",width:2},22:{cls:"service; residential",color:"rgba(200,45,45,1)",width:.2},23:{cls:"steps",color:"rgba(200,45,45,1)",width:2},24:{cls:"tertiary",color:"rgba(200,45,45,1)",width:2},25:{cls:"tertiary_link",color:"rgba(200,45,45,1)",width:2},26:{cls:"track",color:"rgba(200,45,45,1)",width:2},27:{cls:"trunk",color:"rgba(200,45,45,1)",width:2},28:{cls:"trunk_link",color:"rgba(200,45,45,1)",width:2},29:{cls:"unclassified",color:"rgba(200,45,45,1)",width:2}},f={},g=null,h=null,i=0,j=512;bicsymaps.image=function(){var a={},b,c,d=Math.round;a.view=function(c){if(!arguments.length)return b;b=c;return a},a.url=function(b){if(!arguments.length)return c;c=typeof b=="string"&&/{.}/.test(b)?_url(b):b;return a},a.zoom=function(b){if(!arguments.length)return d;d=typeof b=="function"?b:function(){return b};return a},a.render=function(e,f){function D(a,b){C=A.push([a,b,B])}var g=e.getContext("2d"),h=b.size(),i=b.angle(),j=b.center(),l=j[2],m=b.coordinateSize(),n=l-(l=d(l)),p=Math.pow(2,-n),q=b.coordinate([0,0]),r=b.coordinate([h[0],0]),s=b.coordinate(h),t=b.coordinate([0,h[1]]);q[0]*=p,r[0]*=p,s[0]*=p,t[0]*=p,q[1]*=p,r[1]*=p,s[1]*=p,t[1]*=p,q[2]=r[2]=s[2]=t[2]-=n;var u=Math.floor(Math.min(q[0],r[0],s[0],t[0])),v=Math.ceil(Math.max(q[0],r[0],s[0],t[0])),w=Math.floor(Math.min(q[1],r[1],s[1],t[1])),x=Math.ceil(Math.max(q[1],r[1],s[1],t[1])),y=m[0],z=m[1],A=[],B=q[2],C=0;o(q,r,s,D),o(s,t,q,D);var E=h[0]/2+y*(u-j[0]*p)|0,F=h[1]/2+z*(w-j[1]*p)|0;e.style.webkitTransform="matrix3d(1,0,0,0,0,1,0,0,0,0,1,0,"+E+","+F+",0,1)",e.width=(v-u)*y,e.height=(x-w)*z,A.forEach(function(a){function d(){!--C&&f&&f()}var b=c(a);return b==null?d():k(b,function(b){var c=y*(a[0]-u),e=z*(a[1]-w);g.drawImage(b,y*(a[0]-u),z*(a[1]-w)),d()})});return a};return a};var p={},q=/^(?:([^:\/?\#]+):)?(?:\/\/([^\/?\#]*))?([^?\#]*)(?:\?([^\#]*))?(?:\#(.*))?/,r=36,s=24;bicsymaps.url=function(a){function d(d){var e=d[0],f=d[1],g=d[2],h=1<<g;/^repeat(-x)?$/.test(c)&&(e=e%h)<0&&(e+=h),/^repeat(-y)?$/.test(c)&&(f=f%h)<0&&(f+=h);if(g<0||e<0||e>=h||f<0||f>=h)return null;return a.replace(/{(.)}/g,function(a,c){switch(c){case"X":return e;case"Y":return f;case"Z":return g;case"S":return b[Math.abs(e+f+g)%b.length]}return c})}var b=[],c="repeat-x";d.template=function(b){if(!arguments.length)return a;a=b;return d},d.hosts=function(a){if(!arguments.length)return b;b=a;return d},d.repeat=function(a){if(!arguments.length)return c;c=a;return d};return d},bicsymaps.view=function(){function j(b){var c=Math.pow(2,b);return a.center([d[0]*c,d[1]*c,d[2]+b])}var a={},b=[0,0],c=[255,255],d=[.5,.5,0],e=0,f=1,g=0,h=1,i=0;a.point=function(a){var e=Math.pow(2,d[2]-(a.length<3?0:a[2])),h=(a[0]*e-d[0])*c[0],i=(a[1]*e-d[1])*c[1];return[b[0]/2+f*h-g*i,b[1]/2+g*h+f*i]},a.coordinate=function(a){var e=a[0]-b[0]/2;dy=a[1]-b[1]/2;return[d[0]+(h*e-i*dy)/c[0],d[1]+(i*e+h*dy)/c[1],d[2]]},a.coordinateSize=function(b){if(!arguments.length)return c;c=b;return a},a.size=function(c){if(!arguments.length)return b;b=c;return a},a.center=function(b){if(!arguments.length)return d;d=b,d.length<3&&(d[2]=0);return a},a.zoom=function(a){if(!arguments.length)return d[2];return j(a-d[2])},a.angle=function(b){if(!arguments.length)return e;e=b,f=Math.cos(e),g=Math.sin(e),h=Math.cos(-e),i=Math.sin(-e);return a},a.panBy=function(b){return a.center([d[0]-(i*b[1]+h*b[0])/c[0],d[1]-(h*b[1]-i*b[0])/c[1],d[2]])},a.zoomBy=function(b,c,d){if(arguments.length<2)return j(b);arguments.length<3&&(d=a.coordinate(c));var e=j(b).point(d);return a.panBy([c[0]-e[0],c[1]-e[1]])},a.rotateBy=function(b){return a.angle(e+b)};return a}})()